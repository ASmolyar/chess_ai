<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess AI Arena</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <i data-lucide="crown" class="logo-icon"></i>
                <span class="logo-text">Chess AI Arena</span>
            </div>
            <nav class="main-nav">
                <button class="nav-item active" data-tab="game-tab">
                    <i data-lucide="play" class="nav-icon"></i>
                    <span>Play</span>
                </button>
                <button class="nav-item" data-tab="eval-builder-tab">
                    <i data-lucide="settings-2" class="nav-icon"></i>
                    <span>Eval Builder</span>
                </button>
                <button class="nav-item" data-tab="leaderboard-tab">
                    <i data-lucide="trophy" class="nav-icon"></i>
                    <span>Leaderboard</span>
                </button>
            </nav>
            <div class="header-spacer"></div>
        </div>
    </header>

    <div class="app-container">
        <!-- Game Tab -->
        <div id="game-tab" class="tab-content active">
            <div class="game-layout">
                <!-- Left side: Board with player bars -->
                <div class="board-area">
                    <!-- Opponent (top) player bar -->
                    <div class="player-bar opponent-bar">
                        <div class="player-info">
                            <div class="player-avatar bot-avatar">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5A2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5a2.5 2.5 0 0 0 2.5 2.5a2.5 2.5 0 0 0 2.5-2.5a2.5 2.5 0 0 0-2.5-2.5z"/></svg>
                            </div>
                            <div class="player-details">
                                <span class="player-name" id="black-player-name">Random Bot</span>
                                <span class="player-rating" id="opponent-label">BOT</span>
                            </div>
                        </div>
                        <div class="captured-pieces" id="opponent-captured-pieces"></div>
                        <div class="player-clock" id="opponent-clock">
                            <div class="turn-dot" id="opponent-turn"></div>
                        </div>
                    </div>

                    <!-- Chess Board -->
                    <div class="board-container">
                        <div class="board-coordinates left" id="coords-left">
                            <span>8</span><span>7</span><span>6</span><span>5</span>
                            <span>4</span><span>3</span><span>2</span><span>1</span>
                        </div>
                        <div class="chess-board" id="chess-board"></div>
                        <div class="board-coordinates right" id="coords-right">
                            <span>8</span><span>7</span><span>6</span><span>5</span>
                            <span>4</span><span>3</span><span>2</span><span>1</span>
                        </div>
                    </div>
                    <div class="board-coordinates bottom" id="coords-bottom">
                        <span>a</span><span>b</span><span>c</span><span>d</span>
                        <span>e</span><span>f</span><span>g</span><span>h</span>
                    </div>

                    <!-- Player (bottom) player bar -->
                    <div class="player-bar player-bar-bottom">
                        <div class="player-info">
                            <div class="player-avatar human-avatar">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z"/></svg>
                            </div>
                            <div class="player-details">
                                <span class="player-name" id="human-player-name">You</span>
                                <span class="player-rating" id="human-label">HUMAN</span>
                            </div>
                        </div>
                        <div class="captured-pieces" id="human-captured-pieces"></div>
                        <div class="player-clock" id="human-clock">
                            <div class="turn-dot active" id="human-turn"></div>
                        </div>
                    </div>

                    <!-- Promotion Modal (inside board-area for positioning) -->
                    <div class="promotion-modal" id="promotion-modal">
                        <div class="board-overlay"></div>
                        <div class="promotion-content">
                            <h3>Promote Pawn</h3>
                            <div class="promotion-pieces" id="promotion-pieces"></div>
                        </div>
                    </div>

                    <!-- Game Over Modal (inside board-area for positioning) -->
                    <div class="game-over-modal" id="game-over-modal">
                        <div class="board-overlay"></div>
                        <div class="game-over-content">
                            <button class="modal-close" id="modal-close">&times;</button>
                            <div class="game-over-icon" id="game-over-icon"></div>
                            <h2 class="game-over-result" id="game-over-title">White Won</h2>
                            <p class="game-over-reason" id="game-over-message">by checkmate</p>
                            <div class="game-over-buttons">
                                <button class="rematch-btn" id="rematch-btn">Rematch</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right side: Game panel -->
                <div class="side-panel">
                    <!-- New Game Section at top -->
                    <div class="new-game-header">
                        <button class="new-game-btn-large" id="new-game-btn">New Game</button>
                        
                        <div class="game-options">
                            <div class="option-group">
                                <label>Play as</label>
                                <div class="color-selector">
                                    <button class="color-btn active" data-color="white" title="Play as White">
                                        <span class="color-icon white-icon">♔</span>
                                    </button>
                                    <button class="color-btn" data-color="random" title="Random Color">
                                        <span class="color-icon random-icon">?</span>
                                    </button>
                                    <button class="color-btn" data-color="black" title="Play as Black">
                                        <span class="color-icon black-icon">♚</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="option-group">
                                <label>Opponent</label>
                                <select id="bot-select">
                                    <option value="turingbot" selected>TuringBot (Depth 8)</option>
                                    <option value="custom-eval">Custom Eval (Depth 8)</option>
                                    <option value="random">Random Bot</option>
                                    <option value="debug-depth2">Debug (Depth 2)</option>
                                    <option value="debug-depth12">Debug (Depth 12)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Moves Panel -->
                    <div class="moves-section">
                        <div class="moves-header">
                            <span class="moves-title">Moves</span>
                            <span class="opening-name" id="opening-name"></span>
                        </div>
                        <div class="moves-panel">
                            <div class="moves-list" id="moves-list"></div>
                        </div>
                    </div>

                    <!-- Game Status -->
                    <div class="game-status" id="game-status">
                        <span class="status-text">White to move</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eval Builder Tab -->
        <div id="eval-builder-tab" class="tab-content">
            <div class="eval-builder-layout">
                <!-- Left: Block Catalog -->
                <div class="block-catalog">
                    <div class="catalog-header">
                        <h2>Building Blocks</h2>
                        <p>Drag blocks or click to add</p>
                    </div>
                    
                    <div class="catalog-section">
                        <h3>
                            <i data-lucide="filter" class="section-icon"></i>
                            Conditions 
                            <span class="section-hint">When to apply</span>
                        </h3>
                        <div id="condition-blocks" class="block-grid"></div>
                    </div>
                    
                    <div class="catalog-section">
                        <h3>
                            <i data-lucide="crosshair" class="section-icon"></i>
                            Targets 
                            <span class="section-hint">What to evaluate</span>
                        </h3>
                        <div id="target-blocks" class="block-grid"></div>
                    </div>
                    
                    <div class="catalog-section">
                        <h3>
                            <i data-lucide="calculator" class="section-icon"></i>
                            Values 
                            <span class="section-hint">Score amount</span>
                        </h3>
                        <div id="value-blocks" class="block-grid"></div>
                    </div>
                </div>

                <!-- Center: Rule Builder -->
                <div class="rule-builder-area">
                    <div class="builder-header">
                        <input type="text" id="eval-name-input" class="eval-name-input" 
                               placeholder="My Custom Evaluator" value="My Custom Evaluator">
                        <div class="builder-actions">
                            <button id="save-eval-btn" class="action-btn" title="Save">
                                <i data-lucide="save" class="btn-icon"></i>
                                Save
                            </button>
                            <button id="load-eval-btn" class="action-btn" title="Load">
                                <i data-lucide="folder-open" class="btn-icon"></i>
                                Load
                            </button>
                            <button id="export-json-btn" class="action-btn" title="Export JSON">
                                <i data-lucide="download" class="btn-icon"></i>
                                Export
                            </button>
                            <button id="publish-eval-btn" class="action-btn publish-btn" title="Publish to Leaderboard">
                                <i data-lucide="trophy" class="btn-icon"></i>
                                Publish
                            </button>
                        </div>
                    </div>

                    <div class="templates-bar">
                        <span class="templates-label">Templates:</span>
                        <button class="template-btn" data-template="simple">Simple</button>
                        <button class="template-btn" data-template="turing">Turing</button>
                        <button class="template-btn" data-template="aggressive">Aggressive</button>
                    </div>

                    <div class="rule-builder">
                        <div class="builder-header">
                        <h3>Rule Builder</h3>
                            <p class="builder-hint">Build a rule by filling in each part of the sentence below</p>
                        </div>
                        
                        <div class="rule-sentence-builder">
                            <div class="sentence-step step-condition">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-label">
                                        <span class="step-title">Condition</span>
                                        <span class="step-subtitle">When should this rule apply?</span>
                                    </div>
                                    <div id="rule-condition-slot" class="drop-slot condition-slot empty required">
                                        <span class="slot-placeholder">
                                            <i data-lucide="filter" class="placeholder-icon"></i>
                                            <span class="placeholder-text">Click to choose a condition</span>
                                            <span class="placeholder-hint">e.g., "Always", "During endgame", "When I have 2+ rooks"</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sentence-connector">
                                <div class="connector-line"></div>
                                <div class="connector-word">then</div>
                                <div class="connector-line"></div>
                            </div>
                            
                            <div class="sentence-step step-target">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-label">
                                        <span class="step-title">Target</span>
                                        <span class="step-subtitle">What do you want to evaluate?</span>
                                    </div>
                                    <div id="rule-target-slot" class="drop-slot target-slot empty required">
                                        <span class="slot-placeholder">
                                            <i data-lucide="target" class="placeholder-icon"></i>
                                            <span class="placeholder-text">Click to choose what to count</span>
                                            <span class="placeholder-hint">e.g., "Each pawn I have", "Knight mobility", "King safety"</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sentence-connector">
                                <div class="connector-line"></div>
                                <div class="connector-word">award</div>
                                <div class="connector-line"></div>
                            </div>
                            
                            <div class="sentence-step step-value">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-label">
                                        <span class="step-title">Value</span>
                                        <span class="step-subtitle">How many points?</span>
                                    </div>
                                    <div id="rule-value-slot" class="drop-slot value-slot empty required">
                                        <span class="slot-placeholder">
                                            <i data-lucide="calculator" class="placeholder-icon"></i>
                                            <span class="placeholder-text">Click to set the score</span>
                                            <span class="placeholder-hint">e.g., "+100 centipawns" or "f(n) = 10 × √n"</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rule-name-section">
                            <label for="rule-name-input">
                                <i data-lucide="tag" class="label-icon"></i>
                                Rule Name
                            </label>
                            <input type="text" id="rule-name-input" class="rule-name-input" 
                                   placeholder="Give your rule a name (e.g., Pawn Material, Knight Outpost Bonus)">
                        </div>
                        
                        <div class="builder-buttons">
                            <button id="add-rule-btn" class="primary-btn">
                                <i data-lucide="plus" class="btn-icon"></i>
                                Add Rule
                            </button>
                            <button id="clear-builder-btn" class="secondary-btn">
                                <i data-lucide="x" class="btn-icon"></i>
                                Clear
                            </button>
                        </div>
                        </div>
                    </div>

                <!-- Right: Active Rules -->
                    <div class="rules-list-container">
                    <h3>Active Rules <span class="rules-count" id="rules-count"></span></h3>
                        <div id="rules-list" class="rules-list">
                        <div class="empty-rules">No rules yet. Create one using the builder!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard-tab" class="tab-content">
            <div class="leaderboard-layout">
                <!-- Header -->
                <div class="leaderboard-header">
                    <div class="leaderboard-title">
                        <h1>
                            <i data-lucide="trophy" class="title-icon"></i>
                            Eval Leaderboard
                        </h1>
                        <p class="subtitle">Community-created evaluation functions ranked by ELO</p>
                    </div>
                    <div class="leaderboard-actions">
                        <button class="action-btn" id="refresh-leaderboard">
                            <i data-lucide="refresh-cw"></i>
                            Refresh
                        </button>
                        <button class="action-btn primary" id="upload-eval-btn">
                            <i data-lucide="upload"></i>
                            Upload Eval
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="brain"></i></div>
                        <div class="stat-content">
                            <span class="stat-value" id="total-evals">—</span>
                            <span class="stat-label">Total Evals</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="swords"></i></div>
                        <div class="stat-content">
                            <span class="stat-value" id="total-matches">—</span>
                            <span class="stat-label">Matches Played</span>
                        </div>
                    </div>
                    <div class="stat-card highlight">
                        <div class="stat-icon"><i data-lucide="crown"></i></div>
                        <div class="stat-content">
                            <span class="stat-value" id="top-eval">—</span>
                            <span class="stat-label">Top Ranked</span>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <div class="leaderboard-table-container">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="rank-header">#</th>
                                <th data-sort="name">Name</th>
                                <th data-sort="elo">ELO</th>
                                <th data-sort="games_played">Games</th>
                                <th>W/D/L</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr class="empty-row">
                                <td colspan="7">
                                    <div class="loading-spinner"></div>
                                    <span>Loading leaderboard...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- How It Works -->
                <div class="how-it-works">
                    <h3><i data-lucide="help-circle"></i> How ELO is Calculated</h3>
                    <div class="steps-grid">
                        <div class="step">
                            <span class="step-num">1</span>
                            <p>Your eval plays multiple games against Stockfish at various skill levels (800-2600 ELO)</p>
                        </div>
                        <div class="step">
                            <span class="step-num">2</span>
                            <p>All games are played at depth 8 for consistency and fair comparison</p>
                        </div>
                        <div class="step">
                            <span class="step-num">3</span>
                            <p>ELO is calculated using standard Elo rating formulas based on expected vs actual results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Modal -->
            <div class="modal" id="upload-modal">
                <div class="modal-overlay" onclick="leaderboard.hideUploadModal()"></div>
                <div class="modal-content upload-modal-content">
                    <button class="modal-close-btn" id="upload-modal-close">&times;</button>
                    <h2><i data-lucide="upload"></i> Upload Evaluation Function</h2>
                    <p class="modal-subtitle">Share your eval with the community and see how it ranks!</p>
                    
                    <form id="upload-form">
                        <div class="form-group">
                            <label for="upload-name">Eval Name *</label>
                            <input type="text" id="upload-name" placeholder="My Amazing Eval" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="upload-author">Author</label>
                            <input type="text" id="upload-author" placeholder="Anonymous">
                        </div>
                        
                        <div class="form-group">
                            <label for="upload-description">Description</label>
                            <textarea id="upload-description" rows="2" placeholder="What makes this eval special?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="upload-config">
                                Eval Configuration (JSON) *
                                <button type="button" class="inline-btn" id="use-eval-builder">
                                    <i data-lucide="copy"></i> Use from Eval Builder
                                </button>
                            </label>
                            <textarea id="upload-config" rows="10" placeholder='{"name": "...", "rules": [...], ...}' required></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" onclick="leaderboard.hideUploadModal()">Cancel</button>
                            <button type="submit" class="primary-btn" id="upload-submit">
                                <i data-lucide="rocket"></i> Upload & Calculate ELO
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Eval Details Modal -->
            <div class="modal" id="eval-details-modal">
                <div class="modal-overlay" onclick="leaderboard.hideEvalDetails()"></div>
                <div class="modal-content eval-details-content">
                    <button class="modal-close-btn" id="eval-details-close">&times;</button>
                    <div class="eval-header">
                        <h2 id="detail-name">Eval Name</h2>
                        <span class="author-tag">by <span id="detail-author">Anonymous</span></span>
                    </div>
                    
                    <div class="eval-stats-grid">
                        <div class="eval-stat">
                            <span class="eval-stat-value" id="detail-elo">—</span>
                            <span class="eval-stat-label">ELO</span>
                            <span class="eval-stat-confidence" id="detail-confidence"></span>
                        </div>
                        <div class="eval-stat">
                            <span class="eval-stat-value" id="detail-games">0</span>
                            <span class="eval-stat-label">Games</span>
                        </div>
                        <div class="eval-stat">
                            <span class="eval-stat-value" id="detail-record">0/0/0</span>
                            <span class="eval-stat-label">W/D/L</span>
                        </div>
                    </div>
                    
                    <div class="eval-description">
                        <h4>Description</h4>
                        <p id="detail-description">No description provided.</p>
                    </div>
                    
                    <div class="eval-rules-summary">
                        <h4>Rules Overview</h4>
                        <div id="detail-rules" class="rules-list-preview"></div>
                    </div>
                    
                    <div class="eval-actions">
                        <button class="primary-btn" id="play-against-eval">
                            <i data-lucide="swords"></i> Play Against This Eval
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/chess.js"></script>
    <script src="js/bots/bot.js"></script>
    <script src="js/bots/engineBot.js"></script>
    <script src="js/bots/randomBot.js"></script>
    <script>registerDebugBots();</script>
    <script src="js/evalBuilder.js"></script>
    <script src="js/leaderboard.js"></script>
    <script src="js/liveGameViewer.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Tab switching logic
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update buttons
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                // Initialize eval builder if switching to it
                if (btn.dataset.tab === 'eval-builder-tab' && !window.evalBuilder) {
                    window.evalBuilder = new EvalBuilder();
                    window.evalBuilder.init();
                    // Re-initialize icons for dynamically added content
                    lucide.createIcons();
                }
                
                // Initialize leaderboard if switching to it
                if (btn.dataset.tab === 'leaderboard-tab') {
                    initLeaderboard();
                    lucide.createIcons();
                }
            });
        });
    </script>
</body>
</html>
